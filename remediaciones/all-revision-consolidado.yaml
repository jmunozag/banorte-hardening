---
- name: Revisión informativa de controles de seguridad OpenShift y generación de reporte
  hosts: localhost
  gather_facts: no
  connection: local

  vars:
    ingress_ns: openshift-ingress-operator
    report_dir: /tmp/ocp-reports
    report_name: "reporte-ocp-{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

    # CONFIGURACIÓN NOTIFICACIÓN
    send_mail: true
    mail_to: jmunozag@redhat.com
    mail_from: botkev838@gmail.com
    mail_password: "qfni wfkv uxsw dyjf"
    smtp_host: smtp.gmail.com

    send_webhook: false
    webhook_url: https://webhook.empresa.cl/ocp/report

    # REGEX PARA NETWORK POLICIES (Omitir sistema y operadores core)
    system_ns_regex: "^(openshift.*|kube.*|default|stackrox)$"

  tasks:
    # =========================================================
    # RECOLECCIÓN DE DATOS
    # =========================================================
    - name: "Reclectar información del Cluster"
      kubernetes.core.k8s_info:
        api_version: config.openshift.io/v1
        kind: Infrastructure
        name: cluster
      register: infra_info

    - name: "Reclectar configuración OAuth"
      kubernetes.core.k8s_info:
        api_version: config.openshift.io/v1
        kind: OAuth
        name: cluster
      register: oauth_info

    - name: "Reclectar OAuthClients"
      kubernetes.core.k8s_info:
        api_version: oauth.openshift.io/v1
        kind: OAuthClient
      register: oauth_clients

    - name: "Reclectar Namespaces y NetPols"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: "{{ item }}"
      loop: ["Namespace", "NetworkPolicy"]
      register: k8s_resources

    - name: "Asignar facts de recursos"
      set_fact:
        ns_list: "{{ k8s_resources.results[0] }}"
        netpol_list: "{{ k8s_resources.results[1] }}"

    # [Omitimos las tareas intermedias de recolección de CSO, ACS e Ingress por brevedad, asumiendo su existencia previa]
    # ... (Kubeadmin, CLF, ACS, CSO, Ingress) ...

    # =========================================================
    # LÓGICA DE PROCESAMIENTO
    # =========================================================
    - name: "Procesar Secciones del Reporte"
      set_fact:
        cluster_name: "{{ infra_info.resources[0].status.infrastructureName | default('DESCONOCIDO') }}"
        global_timeout: "{{ oauth_info.resources[0].spec.tokenConfig.accessTokenInactivityTimeout | default('NO CONFIGURADO') }}"

    - name: "Procesar Formato Network Policies"
      set_fact:
        netpol_protegidos: >-
          {% set target_ns = ns_list.resources | map(attribute='metadata.name') | reject('match', system_ns_regex) | list %}
          {% set lines = [] %}
          {% for ns in target_ns | sort %}
            {% set ns_pols = netpol_list.resources | selectattr('metadata.namespace', 'equalto', ns) | map(attribute='metadata.name') | list %}
            {% if ns_pols | length > 0 %}
              {% set _ = lines.append('    Namespace: ' + ns + ' (Políticas: ' + ns_pols | join(', ') + ')') %}
            {% endif %}
          {% endfor %}
          {{ lines | join('\n') if lines | length > 0 else '    No se encontraron namespaces protegidos.' }}
        netpol_expuestos: >-
          {% set target_ns = ns_list.resources | map(attribute='metadata.name') | reject('match', system_ns_regex) | list %}
          {% set lines = [] %}
          {% for ns in target_ns | sort %}
            {% set ns_pols = netpol_list.resources | selectattr('metadata.namespace', 'equalto', ns) | list %}
            {% if ns_pols | length == 0 %}
              {% set _ = lines.append('    Namespace: ' + ns) %}
            {% endif %}
          {% endfor %}
          {{ lines | join('\n') if lines | length > 0 else '    Todos los namespaces están protegidos.' }}

    - name: "Procesar Formato Detalle OAuth Clients"
      set_fact:
        oauth_clients_detail: >-
          {% set lines = [] %}
          {% for client in oauth_clients.resources | sort(attribute='metadata.name') %}
            {% set c_tout = client.accessTokenInactivityTimeoutSeconds | default('N/A') %}
            {% set _ = lines.append('Cliente: ' + client.metadata.name + '\nTimeout: ' + c_tout | string + ' s\n---------------------------------------------') %}
          {% endfor %}
          {{ lines | join('\n') }}

    # =========================================================
    # CONSTRUCCIÓN DEL REPORTE FINAL
    # =========================================================
    - name: "Construir reporte final"
      set_fact:
        report_text: |
          REPORTE DE SEGURIDAD OPENSHIFT
          Fecha: {{ lookup('pipe', 'date --iso-8601=seconds') }}
          Cluster: {{ cluster_name }}

          ---------------------------------
          NETWORK POLICIES
          Ensure that application Namespaces have Network Policies defined - ocp4-pci-dss-4-0-configure-network-policies-namespaces

          1. NAMESPACES CON NETWORK POLICIES DEFINIDAS
          ---------------------------------------------
          {{ netpol_protegidos }}

          2. NAMESPACES SIN NETWORK POLICIES (EXPUESTOS)
          ---------------------------------------------
          {{ netpol_expuestos }}

          ---------------------------------
          OAUTH INACTIVITY TIMEOUT
          Configure OAuth tokens to expire after a set period of inactivity - ocp4-pci-dss-4-0-oauth-or-oauthclient-inactivity-timeout

          1. CONFIGURACIÓN GLOBAL (OAuth Server)
          ---------------------------------------------
          Timeout Actual: {{ global_timeout }}

          2. DETALLE DE CLIENTES (OAuthClients)
          ---------------------------------------------
          {{ oauth_clients_detail }}
          
          [... Resto de secciones originales se mantienen igual ...]

    # =========================================================
    # ENVÍO - CORRECCIÓN DE SUBJECT
    # =========================================================
    - name: "Enviar reporte por correo"
      community.general.mail:
        host: "{{ smtp_host }}"
        username: "{{ mail_from }}"
        password: "{{ mail_password }}"
        port: 587
        to: "{{ mail_to }}"
        subject: "Revisión configuraciones controles de seguridad - {{ cluster_name }}"
        body: "{{ report_text }}"
        secure: starttls
        charset: utf-8
      when: send_mail | bool
